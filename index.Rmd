---
title: "New Covid-19 Cases by County"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(shiny)
library(dplyr)
library(readr)
library(ggpubr)
library(ggplot2)
library(RcppRoll)
library(plotly)
source('functions.R')
```

```{r get_data, include=FALSE}

county_data_nyt <<- get_county_nyt()
#county_data_virginia <<- get_virginia()

state_data_nyt <<- get_state_data_nyt()
state_data_covid_tracking <<- get_state_data_covid_tracking()

max_date <- (county_data_nyt$date %>% na.omit %>% max)
default_bin <- 7
```

NYT Data Last updated at *`r max_date`*. Datasets loaded directly from [NY Times](https://github.com/nytimes/covid-19-data) for county data. State data is either NYT or [Covid Tracking](https://covidtracking.com/api).

Virigina county-level data is now default loaded directly from the [Virginia Department of Health](http://www.vdh.virginia.gov/coronavirus/). Other states may be added to this direct download method in the future.

To see bar plots themselves with rolling averages, and no overplotted line, uncheck the overplot box.

# Covid 19 Plots {.tabset}

## Case Growth Plots {.tabset}


```{r echo=FALSE}


inputPanel(
  selectInput("state", label = "State",
              choices = state_data_nyt$state %>% unique %>% sort, selected = 'Virginia'),
  
  sliderInput("bins", label = "Days for Rolling Average",
              min = 1, max = 14, value = 7, step = 1),
  
  checkboxInput("overplot_rolled","Overplot Rolled Average",value=TRUE)
    #checkboxInput("use_county_best",label="Use Direct State Data for County if available", value=TRUE)
  )



```

### County Level

```{r echo=FALSE}

renderUI({
  
      selected_state <- input$state

          county_data <<- county_data_nyt

  # if (input$use_county_best & input$state == 'Virginia') {
  #   county_data <<- county_data_virginia
  #   
  # } else {
  #   county_data <<- county_data_nyt
  # }
  
      inputPanel(
  
  
  selectInput("county", label = "County",
              choices = (county_data %>% filter(state == selected_state))$county %>% unique %>% sort, selected = 'Henrico')
  

)

})

renderPlotly({
  
 county_data <<- county_data_nyt
 
    # if (input$use_county_best & input$state == 'Virginia') {
  #   county_data <<- county_data_virginia
  #   
  # } else {
  #   county_data <<- county_data_nyt
  # }

shiny::validate(need(input$state,message="Please wait.."))
shiny::validate(need(county_data,message="Please wait.."))
shiny::validate(need(input$bins,message="Please wait.."))
shiny::validate(need(input$county,message="Please wait.."))


   if (input$overplot_rolled)
  {
    p <- plot_county2(county_data, input$county, input$state, input$bins)
  } else {
    p <- plot_county_roll(county_data, input$county, input$state, input$bins)
  }
  
  shiny::validate(need(p,message="Please wait.."))
  ggplotly(p,height=500) %>% layout(legend = list(orientation = "h", x = 0.1, y = .8))
  })

```


### State Level
``` {r state plots, echo=FALSE}

inputPanel(
  selectInput("data_source", label = "State Data Source",
              choices = c("New York Times"="nyt","Covid Tracking"='covid_tracking'), selected = 'nyt'))

renderPlotly({
  if (input$data_source == 'nyt') {
    state_data <- state_data_nyt
  } else {
    state_data <- state_data_covid_tracking
  }
  if (input$overplot_rolled)
  {
    pp <- plot_state2(state_data, input$state, input$bins)
  } else {
    pp <- plot_state(state_data, input$state, input$bins)
  }
    ggplotly(pp,height=500) %>% layout(legend = list(orientation = "h", x = 0.1, y = .8))

})

```

## About

Covid Tracking and the New York Times have significantly different total counts for some states, which can lead to very different case growth plots. Covid Tracking updates more frequently, but I am using the NYT as the default data source for state plots.

Covid Tracking includes a `positiveIncrease` column. For the NY Times data, this column is computed with a simple `mutate(case_growth = cases - lag(cases))` after sorting by date.

I have looked for alternatives to county-level data from the [NY Times github](https://github.com/nytimes/covid-19-data). I haven't found any useful sources yet. It is unclear where the [John Hopkins](https://github.com/CSSEGISandData/COVID-19) county data comes from, and the data files that do exist there have a difficult to parse format, with the [values in different columns for different dates](https://github.com/CSSEGISandData/COVID-19/blob/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv)). If I can find another county data source, I will add it.

