---
title: "New Covid-19 Cases by County"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(shiny)
library(dplyr)
library(readr)
library(ggpubr)
library(ggplot2)
library(RcppRoll)
library(plotly)
source('functions.R')
```

```{r get_data, include=FALSE}

county_data <- read_csv(url("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"))
county_data$date <- as.Date(county_data$date)
county_data <- county_data[order(county_data$date),]
county_data <- county_data %>% group_by(county,state) %>% mutate(case_growth = cases - lag(cases))

state_data_nyt <- get_state_data_nyt()
state_data_covid_tracking <- get_state_data_covid_tracking()

max_date <- (county_data$date %>% na.omit %>% max)
default_bin <- 7
```

NYT Data Last updated at *`r max_date`*. Datasets loaded directly from [NY Times](https://github.com/nytimes/covid-19-data) for county data. State data is either NYT or [Covid Tracking](https://covidtracking.com/api).

If you prefer the bar plots themselves made with rolling averages, uncheck the overplot box.

# Covid 19 Plots {.tabset}

## Case Growth Plots {.tabset}


```{r echo=FALSE}


inputPanel(
  selectInput("state", label = "State",
              choices = county_data$state %>% unique %>% sort, selected = 'Virginia'),
  
  sliderInput("bins", label = "Days for Rolling Average",
              min = 1, max = 14, value = 7, step = 1),
  
  checkboxInput("overplot_rolled","Overplot Rolled Average",value=TRUE)
  )



```

### County Level

```{r echo=FALSE}

renderUI({
  selected_state <- input$state

  inputPanel(

  
  
  selectInput("county", label = "County",
              choices = (county_data %>% filter(state == selected_state))$county %>% unique %>% sort, selected = 'Henrico')
)

})

renderPlotly({
  
  


  shiny::validate(need(input$county,message="Please wait.."))

   if (input$overplot_rolled)
  {
    p <- plot_county2(county_data, input$county, input$state, input$bins)
  } else {
    p <- plot_county_roll(county_data, input$county, input$state, input$bins)
  }
  ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0.1, y = .8))
  })

```

Putting some text here to test.

### State Level
``` {r state plots, echo=FALSE}

inputPanel(
  selectInput("data_source", label = "State Data Source",
              choices = c("New York Times"="nyt","Covid Tracking"='covid_tracking'), selected = 'nyt'))

renderPlotly({
  if (input$data_source == 'nyt') {
    state_data <- state_data_nyt
  } else {
    state_data <- state_data_covid_tracking
  }
  if (input$overplot_rolled)
  {
    pp <- plot_state2(state_data, input$state, input$bins)
  } else {
    pp <- plot_state(state_data, input$state, input$bins)
  }
    ggplotly(pp) %>% layout(legend = list(orientation = "h", x = 0.1, y = .8))

})

```

## About

Covid Tracking and the New York Times have significantly different total counts for some states, which can lead to very different case growth plots. Covid Tracking updates more frequently, but I am defaulting to NYT for state plots for the time being.

Covid Tracking includes a `positiveIncrease` column. For the NY Times data, this column is computed with a simple `mutate(case_growth = cases - lag(cases))` after sorting by date.
